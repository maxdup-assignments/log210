// Generated by CoffeeScript 1.8.0
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  angular.module('resto.commandeControllers', ['ui.bootstrap']).controller('CommandeController', function($scope, $http, $routeParams) {
    var param;
    param = $routeParams.param;
    $scope.order = {
      'details': {
        'commande': [],
        'adresse': '',
        'time': new Date()
      },
      'restaurant': param
    };
    $http.get('api/profile').success(function(data) {
      $scope.profile = data;
      return $scope.order.details.adresse = $scope.profile.adresse[0];
    });
    $http.get('api/all_resto').success(function(data) {
      var resto;
      if (param) {
        return $scope.current_resto = ((function() {
          var _i, _len, _results;
          _results = [];
          for (resto = _i = 0, _len = data.length; _i < _len; resto = ++_i) {
            resto = data[resto];
            if (resto.pk === param) {
              _results.push(resto);
            }
          }
          return _results;
        })())[0];
      }
    });
    $scope.add_item = function(item) {
      if (__indexOf.call($scope.order.details.commande, item) >= 0) {
        return item.qty += 1;
      } else {
        item.qty = 1;
        return $scope.order.details.commande.push(item);
      }
    };
    $scope.remove_item = function(item) {
      return $scope.order.details.commande = _.without($scope.order.details.commande, item);
    };
    $scope.qty_adjust = function(item, adjustment) {
      return item.qty = Math.max(0, item.qty + adjustment);
    };
    $scope.total = function() {
      var item, total, _i, _len, _ref;
      total = 0;
      _ref = $scope.order.details.commande;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        total += item.price * item.qty;
      }
      return total;
    };
    $scope.place_order = function() {
      if ($scope.order.details.adresse === '##new') {
        $scope.profile.adresse.push($scope.new_address);
        $scope.order.details.adresse = $scope.new_address;
        console.log('new profile', $scope.profile);
        $http.post('api/edit_profile', $scope.profile).error(function(data) {
          return console.log(data);
        });
      }
      return $http.post('api/create_commande', $scope.order).success(function(data) {
        alert('commande envoyÃ©');
        return console.log(data);
      }).error(function(data) {
        return console.log(data);
      });
    };
    $scope.minDate = new Date();
    $scope.hstep = 1;
    $scope.mstep = 15;
    return $scope.open = function($event) {
      $event.preventDefault();
      $event.stopPropagation();
      return $scope.opened = true;
    };
  }).controller('CommandeManageController', function($scope, $http, $routeParams) {
    var param;
    param = $routeParams.param;
    $scope.commandes = [];
    $http.post('api/resto_commande', param).success(function(data) {
      return $scope.commandes = data;
    }).error(function(data) {
      return console.log(data);
    });
    return $scope.update_status = function(commande, status) {
      return $http.post('api/update_commande_status', {
        'status': status,
        'commande': commande
      }).success(function(data) {
        return commande.status = status;
      });
    };
  });

}).call(this);
